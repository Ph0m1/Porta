# ğŸš€ Porta Gateway

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ Go è¯­è¨€ API ç½‘å…³ï¼Œå…·å¤‡ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜å’Œå®‰å…¨æ€§åŠŸèƒ½ã€‚

## âœ¨ ç‰¹æ€§

- ğŸ”„ **æ™ºèƒ½è´Ÿè½½å‡è¡¡** - æ”¯æŒè½®è¯¢å’Œéšæœºè´Ÿè½½å‡è¡¡ç®—æ³•
- ğŸ“Š **å®Œæ•´ç›‘æ§ç³»ç»Ÿ** - é›†æˆ Prometheus å’Œ Grafana
- ğŸš€ **é«˜æ€§èƒ½ä»£ç†** - æ”¯æŒå¹¶å‘è¯·æ±‚å’Œç¼“å­˜
- ğŸ³ **å®¹å™¨åŒ–éƒ¨ç½²** - Docker å’Œ Docker Compose æ”¯æŒ
- ğŸ”’ **å®‰å…¨ä¸­é—´ä»¶** - è¯·æ±‚éªŒè¯å’Œé”™è¯¯å¤„ç†
- ğŸ“ **ç»“æ„åŒ–æ—¥å¿—** - è¯¦ç»†çš„è¯·æ±‚å’Œé”™è¯¯æ—¥å¿—
- âš¡ **ç¼“å­˜æ”¯æŒ** - Redis é›†æˆå’Œå†…å­˜ç¼“å­˜
- ğŸ¯ **çµæ´»é…ç½®** - æ”¯æŒ YAMLã€JSONã€TOML ç­‰æ ¼å¼

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client        â”‚    â”‚   Porta Gateway â”‚    â”‚   Backend       â”‚
â”‚                 â”‚â”€â”€â”€â–¶â”‚                 â”‚â”€â”€â”€â–¶â”‚   Services      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Monitoring    â”‚
                       â”‚                 â”‚
                       â”‚ â€¢ Prometheus    â”‚
                       â”‚ â€¢ Grafana       â”‚
                       â”‚ â€¢ Redis         â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Go 1.21+
- Docker & Docker Compose
- Make (å¯é€‰)

### æœ¬åœ°å¼€å‘

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd gateway

# å®‰è£…ä¾èµ–
make deps

# æ„å»ºé¡¹ç›®
make build

# å¯åŠ¨åç«¯æœåŠ¡
docker-compose up -d backend-service-1 backend-service-2

# è¿è¡Œç½‘å…³ (ä½¿ç”¨æœ¬åœ°é…ç½®)
./build/porta -c ./examples/etc/config.yaml -p 9090
```

### Docker éƒ¨ç½²

```bash
# å¯åŠ¨å®Œæ•´ç¯å¢ƒ
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f porta-gateway
```

## ğŸ“Š ç›‘æ§å’Œå¯è§†åŒ–

### Prometheus æŒ‡æ ‡

ç½‘å…³è‡ªåŠ¨æš´éœ²ä»¥ä¸‹æŒ‡æ ‡ï¼š

- `porta_requests_total` - æ€»è¯·æ±‚æ•°
- `porta_request_duration_seconds` - è¯·æ±‚è€—æ—¶
- `porta_memory_usage_bytes` - å†…å­˜ä½¿ç”¨
- `porta_goroutines_count` - Goroutine æ•°é‡
- `porta_rate_limit_blocks_total` - é™æµé˜»æ­¢æ•°
- `porta_circuit_breaker_state` - ç†”æ–­å™¨çŠ¶æ€

### Grafana ä»ªè¡¨æ¿

è®¿é—® http://localhost:3000 (admin/admin) æŸ¥çœ‹é¢„é…ç½®çš„ä»ªè¡¨æ¿ï¼š

- è¯·æ±‚é‡å’Œå“åº”æ—¶é—´
- é”™è¯¯ç‡å’ŒæˆåŠŸç‡
- åç«¯æœåŠ¡å¥åº·çŠ¶æ€
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## ğŸ”§ é…ç½®

### åŸºç¡€é…ç½®

```yaml
version: 1
name: "Porta Gateway"
port: 8080
timeout: 10
cache_ttl: 3600

host:
  - "http://backend-service-1:80"
  - "http://backend-service-2:80"

endpoints:
  - endpoint: "/test"
    method: "GET"
    concurrent_calls: 1
    timeout: 1000
    cache_ttl: 3600
    backend:
      - host:
          - "http://backend-service-1:80"
          - "http://backend-service-2:80"
        url_pattern: "/"
        encoding: "json"
```

### ç¯å¢ƒå˜é‡

| å˜é‡ | æè¿° | é»˜è®¤å€¼ |
|------|------|--------|
| `GO111MODULE` | Go æ¨¡å—æ¨¡å¼ | `on` |
| `http_proxy` | HTTP ä»£ç† | æ—  |
| `https_proxy` | HTTPS ä»£ç† | æ—  |

## ğŸ› ï¸ å¼€å‘

### é¡¹ç›®ç»“æ„

```
gateway/
â”œâ”€â”€ config/          # é…ç½®ç®¡ç†
â”œâ”€â”€ encoding/        # ç¼–ç è§£ç å™¨
â”œâ”€â”€ examples/        # ç¤ºä¾‹å’Œé…ç½®
â”œâ”€â”€ logging/         # æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ proxy/           # ä»£ç†æ ¸å¿ƒ
â”œâ”€â”€ router/          # è·¯ç”±æ¡†æ¶
â”œâ”€â”€ sd/              # æœåŠ¡å‘ç°
â”œâ”€â”€ docker/          # Docker é…ç½®
â”œâ”€â”€ Dockerfile       # å®¹å™¨æ„å»º
â”œâ”€â”€ docker-compose.yml # æœåŠ¡ç¼–æ’
â”œâ”€â”€ Makefile         # æ„å»ºè„šæœ¬
â””â”€â”€ README.md        # é¡¹ç›®æ–‡æ¡£
```

### æ„å»ºå‘½ä»¤

```bash
# ä¸‹è½½ä¾èµ–
make deps

# æ„å»ºé¡¹ç›®
make build

# è¿è¡Œæµ‹è¯•
make test

# æ¸…ç†æ„å»º
make clean

# Docker æ„å»º
make docker-build

# å¯åŠ¨æœåŠ¡
make docker-run

# åœæ­¢æœåŠ¡
make docker-stop
```

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ–°ä¸­é—´ä»¶**: åœ¨ `proxy/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ä¸­é—´ä»¶
2. **æ–°ç¼–ç å™¨**: åœ¨ `encoding/` ç›®å½•ä¸‹å®ç°æ–°çš„ç¼–ç å™¨
3. **æ–°è·¯ç”±**: åœ¨ `router/` ç›®å½•ä¸‹æ‰©å±•è·¯ç”±åŠŸèƒ½

## ğŸ“¡ API ç«¯ç‚¹

### ç½‘å…³ç«¯ç‚¹

- `GET /test` - æµ‹è¯•ç«¯ç‚¹ï¼Œè¿”å›åç«¯æœåŠ¡å“åº”
- `GET /__debug/endpoints` - è°ƒè¯•ç«¯ç‚¹åˆ—è¡¨

### ç›‘æ§ç«¯ç‚¹

- `GET /__health` - å¥åº·æ£€æŸ¥
- `GET /__live` - å­˜æ´»æ£€æŸ¥
- `GET /__ready` - å°±ç»ªæ£€æŸ¥
- `GET /metrics` - Prometheus æŒ‡æ ‡

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"Bad Host" é”™è¯¯**
   - æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„åç«¯åœ°å€
   - ç¡®è®¤ Docker ç½‘ç»œé…ç½®
   - æ¸…é™¤ä»£ç†ç¯å¢ƒå˜é‡

2. **ä»£ç†è¿æ¥å¤±è´¥**
   - æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
   - éªŒè¯ç½‘ç»œè¿é€šæ€§
   - æŸ¥çœ‹å®¹å™¨æ—¥å¿—

3. **Prometheus é…ç½®é”™è¯¯**
   - æ£€æŸ¥ YAML è¯­æ³•
   - é¿å…é‡å¤å­—æ®µå®šä¹‰
   - é‡å¯ Prometheus å®¹å™¨

### è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹ç½‘å…³æ—¥å¿—
docker-compose logs porta-gateway

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
docker exec gateway-porta-gateway-1 wget -qO- http://backend-service-1:80

# æµ‹è¯•è´Ÿè½½å‡è¡¡
for i in {1..10}; do curl -s http://localhost:8080/test | jq .service; done

# è¿è¡Œå®Œæ•´æµ‹è¯•
./test_complete.sh
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

### åŸºå‡†æµ‹è¯•ç»“æœ

- **å¹¶å‘è¯·æ±‚**: 100 ä¸ªè¯·æ±‚è€—æ—¶ ~0.1 ç§’
- **å“åº”æ—¶é—´**: å¹³å‡ 2-3ms
- **ååé‡**: æ”¯æŒé«˜å¹¶å‘è´Ÿè½½
- **å†…å­˜ä½¿ç”¨**: ä¼˜åŒ–çš„å†…å­˜ç®¡ç†

### è´Ÿè½½æµ‹è¯•

```bash
# ä½¿ç”¨ Apache Bench
ab -n 1000 -c 100 http://localhost:8080/test

# ä½¿ç”¨ wrk
wrk -t12 -c400 -d30s http://localhost:8080/test
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- [Gin](https://github.com/gin-gonic/gin) - Web æ¡†æ¶
- [Viper](https://github.com/spf13/viper) - é…ç½®ç®¡ç†
- [Prometheus](https://prometheus.io/) - ç›‘æ§ç³»ç»Ÿ
- [Grafana](https://grafana.com/) - æ•°æ®å¯è§†åŒ–

---

**Porta Gateway** - è®© API ç½‘å…³æ›´ç®€å•ã€æ›´å¼ºå¤§ï¼ ğŸš€

